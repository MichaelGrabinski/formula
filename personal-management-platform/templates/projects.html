{% extends 'base.html' %}

{% block content %}
<h1 class="text-2xl font-semibold mb-6">Projects</h1>

<div class="flex items-center justify-between mb-6">
    <form method="get" class="flex items-center space-x-2">
        <input type="text" name="search" value="{{ search_query }}" class="flex-1 p-2 border border-input rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary-foreground" placeholder="Search projects" />
        <select name="status" class="p-2 border border-input">
            <option value="">All Statuses</option>
            <option value="PLANNED" {% if status_selected == 'PLANNED' %}selected{% endif %}>Planned</option>
            <option value="IN_PROGRESS" {% if status_selected == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
            <option value="COMPLETED" {% if status_selected == 'COMPLETED' %}selected{% endif %}>Completed</option>
            <option value="ON_HOLD" {% if status_selected == 'ON_HOLD' %}selected{% endif %}>On Hold</option>
        </select>
        <button type="submit" class="px-4 py-2 bg-secondary text-secondary-foreground rounded-r-md hover:bg-secondary-foreground hover:text-secondary">Search</button>
    </form>
    <div class="flex gap-2">
      <a href="{% url 'global_calendar' %}" class="px-4 py-2 bg-accent text-accent-foreground rounded">Global Calendar</a>
      {% if form %}
      <button onclick="document.getElementById('add-project-form').classList.toggle('hidden')" class="px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary-foreground hover:text-primary">Add Project</button>
      {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
  <div class="xl:col-span-2">
    {% if form %}
    <div id="add-project-form" class="{% if edit_project %}mb-6{% else %}hidden mb-6{% endif %}">
      <form method="post" class="mb-6">
          {% csrf_token %}
          <div class="mb-4 space-y-2">
              {{ form.as_p }}
          </div>
          <button type="submit" class="px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary-foreground hover:text-primary">{% if edit_project %}Save Changes{% else %}Add Project{% endif %}</button>
      </form>
    </div>
    {% endif %}

    <!-- Collapsible project list with inline sections and tasks -->
    <div class="space-y-3">
      {% for project in page_obj %}
        <div class="border border-border rounded overflow-hidden">
          <button type="button" class="w-full text-left px-4 py-3 bg-secondary text-secondary-foreground flex items-center justify-between" onclick="toggleProject('{{ project.id }}')">
            <span class="font-medium">{{ project.name }}</span>
            <span class="text-sm">{{ project.status }} • {{ project.tasks.count }} tasks</span>
          </button>
          <div id="project-{{ project.id }}" class="hidden p-4 space-y-6" data-events='[
            {% for t in project.tasks.all %}
              {% if t.start_date or t.due_date %}
                {"title":"{{ t.title|escapejs }}","start":"{{ t.start_date|date:"Y-m-d" }}","end":"{{ t.due_date|date:"Y-m-d" }}",
                 "backgroundColor":"{% if t.status == 'IN_PROGRESS' %}#3b82f6{% elif t.status == 'DONE' %}#10b981{% else %}#f59e0b{% endif %}",
                 "borderColor":"{% if t.status == 'IN_PROGRESS' %}#3b82f6{% elif t.status == 'DONE' %}#10b981{% else %}#f59e0b{% endif %}",
                 "textColor":"#111827" }{% if not forloop.last %},{% endif %}
              {% endif %}
            {% endfor %}
          ]'>
            <div class="flex items-center justify-between text-xs">
              <div>
                {% if project.status == 'IN_PROGRESS' %}
                  <span class="px-2 py-0.5 rounded bg-blue-100 text-blue-800">In Progress</span>
                {% elif project.status == 'COMPLETED' %}
                  <span class="px-2 py-0.5 rounded bg-green-100 text-green-800">Completed</span>
                {% elif project.status == 'ON_HOLD' %}
                  <span class="px-2 py-0.5 rounded bg-purple-100 text-purple-800">On Hold</span>
                {% else %}
                  <span class="px-2 py-0.5 rounded bg-amber-100 text-amber-800">Planned</span>
                {% endif %}
                {% if project.budget %}<span class="ml-2 text-muted-foreground">Budget: ${{ project.budget }}</span>{% endif %}
              </div>
              <div class="flex items-center gap-2">
                <a href="{% url 'edit_project' project.id %}" class="px-2 py-1 rounded bg-primary text-primary-foreground hover:bg-primary/80">Edit Project</a>
                <a href="{% url 'delete_project' project.id %}" class="px-2 py-1 rounded bg-destructive text-destructive-foreground hover:bg-destructive/80" onclick="return confirm('Delete this project?')">Delete</a>
              </div>
            </div>

            {% if edit_task and selected_project and selected_project.id == project.id and task_form %}
            <div class="border border-border rounded p-4 bg-muted/20">
              <h4 class="font-semibold mb-2">Edit Task</h4>
              <form method="post" action="{% url 'edit_task' task_form.instance.id %}?project={{ project.id }}" class="space-y-2">
                {% csrf_token %}
                {{ task_form.as_p }}
                <div class="flex gap-2">
                  <button type="submit" class="px-3 py-2 bg-primary text-primary-foreground rounded">Save</button>
                  <a class="px-3 py-2 border rounded" href="{% url 'projects' %}?project={{ project.id }}">Cancel</a>
                </div>
              </form>
            </div>
            {% endif %}

            <!-- Restored Details + Quick Add + Import/Export -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="font-semibold mb-2">Details</h4>
                <ul class="text-sm space-y-1">
                  <li>Assigned: {{ project.assigned_to|default:"-" }}</li>
                  <li>Budget: {% if project.budget %}${{ project.budget }}{% else %}-{% endif %}</li>
                  <li>Dates: {% if project.start_date %}{{ project.start_date }}{% else %}—{% endif %} → {% if project.end_date %}{{ project.end_date }}{% else %}—{% endif %}</li>
                </ul>
                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                  <a class="px-2 py-1 border rounded" href="{% url 'projects' %}?export=tasks_json&project={{ project.id }}">Export Tasks JSON</a>
                  <a class="px-2 py-1 border rounded" href="{% url 'projects' %}?export=projects_json&project={{ project.id }}">Export Project JSON</a>
                  <a class="px-2 py-1 border rounded" href="{% url 'projects' %}?export=tasks_csv_template">Download CSV template</a>
                  <form method="post" enctype="multipart/form-data" class="inline-flex items-center gap-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="import_tasks_csv" />
                    <input type="hidden" name="project" value="{{ project.id }}" />
                    <input type="file" name="file" accept=".csv" class="text-xs" />
                    <button class="px-2 py-1 bg-secondary text-secondary-foreground rounded" type="submit">Import CSV</button>
                  </form>
                  <form method="post" enctype="multipart/form-data" class="inline-flex items-center gap-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="import_tasks_json" />
                    <input type="hidden" name="project" value="{{ project.id }}" />
                    <input type="file" name="file" accept=".json,application/json" class="text-xs" />
                    <button class="px-2 py-1 bg-secondary text-secondary-foreground rounded" type="submit">Import JSON</button>
                  </form>
                </div>
              </div>
              <div>
                <h4 class="font-semibold mb-2">Quick Add Task</h4>
                <form method="post" class="space-y-2">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_task" />
                  <input type="hidden" name="project" value="{{ project.id }}" />
                  <input class="w-full p-2 border border-input rounded" name="title" placeholder="Task title" required />
                  <textarea class="w-full p-2 border border-input rounded" name="description" rows="2" placeholder="Short description (optional)"></textarea>
                  <input class="w-full p-2 border border-input rounded" name="section" placeholder="Section (optional)" />
                  <div class="flex gap-2">
                    <select name="status" class="p-2 border border-input flex-1">
                      <option value="TODO">To Do</option>
                      <option value="IN_PROGRESS">In Progress</option>
                      <option value="DONE">Done</option>
                    </select>
                    <select name="priority" class="p-2 border border-input flex-1">
                      <option value="">Priority</option>
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                    </select>
                  </div>
                  <div class="flex gap-2">
                    <input class="p-2 border border-input rounded flex-1" type="date" name="start_date" />
                    <input class="p-2 border border-input rounded flex-1" type="date" name="due_date" />
                  </div>
                  <div class="flex gap-2">
                    <input class="p-2 border border-input rounded flex-1" type="number" name="progress" min="0" max="100" placeholder="Progress %" />
                    <input class="p-2 border border-input rounded flex-1" name="assigned_to" placeholder="Assignee" />
                  </div>
                  <div class="flex items-center gap-4 text-sm">
                    <label class="inline-flex items-center gap-2"><input type="checkbox" name="ai_suggested" class="h-4 w-4" /> Mark as AI-suggested</label>
                    <label class="inline-flex items-center gap-2"><input type="checkbox" name="enrich_on_add" class="h-4 w-4" /> Enrich with AI after adding</label>
                  </div>
                  <button type="submit" class="px-3 py-2 bg-primary text-primary-foreground rounded">Add</button>
                </form>
              </div>
            </div>

            <!-- Jump links -->
            <div class="mt-4 text-xs text-muted-foreground flex flex-wrap gap-3">
              <a href="#tasks-{{ project.id }}" class="underline hover:no-underline">Jump to Tasks</a>
              <a href="#cal-{{ project.id }}" class="underline hover:no-underline">Jump to Calendar</a>
              <a href="#gchart-{{ project.id }}" class="underline hover:no-underline">Jump to Gantt</a>
              <a href="#media-{{ project.id }}" class="underline hover:no-underline">Jump to Media</a>
            </div>

            <!-- Tasks (moved above Calendar/Gantt/Media) -->
            <div id="tasks-{{ project.id }}" class="space-y-6 mt-4">
              <h4 class="font-semibold">Tasks</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- To Do -->
                <div>
                  <h5 class="text-sm font-medium mb-2">To Do</h5>
                  {% for task in project.tasks.all %}
                    {% if task.status == 'TODO' %}
                    <div class="border border-border rounded p-4 min-h-[160px] bg-amber-50 text-amber-900">
                      <div class="flex items-start justify-between gap-3">
                        <div class="font-medium text-base truncate" title="{{ task.title }}">{{ task.title }}</div>
                        <div class="flex items-center gap-2 text-xs">
                          <span class="px-2 py-0.5 rounded" style="background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.08);">TODO</span>
                          {% if task.priority %}<span class="px-2 py-0.5 rounded bg-white/60 border">{{ task.priority }}</span>{% endif %}
                          {% if task.ai_suggested %}<span class="px-2 py-0.5 rounded bg-green-100 text-green-700">AI</span>{% endif %}
                        </div>
                      </div>
                      {% if task.assigned_to %}<div class="mt-1 text-xs opacity-80">Assigned: {{ task.assigned_to }}</div>{% endif %}
                      {% if task.section %}<div class="text-xs opacity-80">Section: {{ task.section }}</div>{% endif %}
                      {% if task.description %}<div class="mt-2 text-sm max-h-16 overflow-hidden">{{ task.description }}</div>{% endif %}
                      {% if task.start_date or task.due_date %}
                        <div class="mt-2 text-xs opacity-80">{{ task.start_date|default:'?' }} → {{ task.due_date|default:'?' }}</div>
                      {% endif %}
                      <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
                        <a class="px-2 py-1 bg-accent text-accent-foreground rounded" href="{% url 'edit_task' task.id %}?project={{ project.id }}">Edit</a>
                        <a class="px-2 py-1 bg-destructive text-destructive-foreground rounded" href="{% url 'delete_task' task.id %}" onclick="return confirm('Delete this task?');">Delete</a>
                        <form method="post" action="{% url 'enrich_task' task.id %}" class="inline">
                          {% csrf_token %}
                          <button class="px-2 py-1 bg-secondary text-secondary-foreground rounded" title="Enrich with AI" type="submit">Enrich</button>
                        </form>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- In Progress -->
                <div>
                  <h5 class="text-sm font-medium mb-2">In Progress</h5>
                  {% for task in project.tasks.all %}
                    {% if task.status == 'IN_PROGRESS' %}
                    <div class="border border-border rounded p-4 min-h-[160px] bg-blue-50 text-blue-900">
                      <div class="flex items-start justify-between gap-3">
                        <div class="font-medium text-base truncate" title="{{ task.title }}">{{ task.title }}</div>
                        <div class="flex items-center gap-2 text-xs">
                          <span class="px-2 py-0.5 rounded" style="background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.08);">In Progress</span>
                          {% if task.priority %}<span class="px-2 py-0.5 rounded bg-white/60 border">{{ task.priority }}</span>{% endif %}
                          {% if task.ai_suggested %}<span class="px-2 py-0.5 rounded bg-green-100 text-green-700">AI</span>{% endif %}
                        </div>
                      </div>
                      {% if task.assigned_to %}<div class="mt-1 text-xs opacity-80">Assigned: {{ task.assigned_to }}</div>{% endif %}
                      {% if task.section %}<div class="text-xs opacity-80">Section: {{ task.section }}</div>{% endif %}
                      {% if task.description %}<div class="mt-2 text-sm max-h-16 overflow-hidden">{{ task.description }}</div>{% endif %}
                      {% if task.start_date or task.due_date %}
                        <div class="mt-2 text-xs opacity-80">{{ task.start_date|default:'?' }} → {{ task.due_date|default:'?' }}</div>
                      {% endif %}
                      <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
                        <a class="px-2 py-1 bg-accent text-accent-foreground rounded" href="{% url 'edit_task' task.id %}?project={{ project.id }}">Edit</a>
                        <a class="px-2 py-1 bg-destructive text-destructive-foreground rounded" href="{% url 'delete_task' task.id %}" onclick="return confirm('Delete this task?');">Delete</a>
                        <form method="post" action="{% url 'enrich_task' task.id %}" class="inline">
                          {% csrf_token %}
                          <button class="px-2 py-1 bg-secondary text-secondary-foreground rounded" title="Enrich with AI" type="submit">Enrich</button>
                        </form>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- Done -->
                <div>
                  <h5 class="text-sm font-medium mb-2">Done</h5>
                  {% for task in project.tasks.all %}
                    {% if task.status == 'DONE' %}
                    <div class="border border-border rounded p-4 min-h-[160px] bg-green-50 text-green-900">
                      <div class="flex items-start justify-between gap-3">
                        <div class="font-medium text-base truncate" title="{{ task.title }}">{{ task.title }}</div>
                        <div class="flex items-center gap-2 text-xs">
                          <span class="px-2 py-0.5 rounded" style="background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.08);">Done</span>
                          {% if task.priority %}<span class="px-2 py-0.5 rounded bg-white/60 border">{{ task.priority }}</span>{% endif %}
                          {% if task.ai_suggested %}<span class="px-2 py-0.5 rounded bg-green-100 text-green-700">AI</span>{% endif %}
                        </div>
                      </div>
                      {% if task.assigned_to %}<div class="mt-1 text-xs opacity-80">Assigned: {{ task.assigned_to }}</div>{% endif %}
                      {% if task.section %}<div class="text-xs opacity-80">Section: {{ task.section }}</div>{% endif %}
                      {% if task.description %}<div class="mt-2 text-sm max-h-16 overflow-hidden">{{ task.description }}</div>{% endif %}
                      {% if task.start_date or task.due_date %}
                        <div class="mt-2 text-xs opacity-80">{{ task.start_date|default:'?' }} → {{ task.due_date|default:'?' }}</div>
                      {% endif %}
                      <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
                        <a class="px-2 py-1 bg-accent text-accent-foreground rounded" href="{% url 'edit_task' task.id %}?project={{ project.id }}">Edit</a>
                        <a class="px-2 py-1 bg-destructive text-destructive-foreground rounded" href="{% url 'delete_task' task.id %}" onclick="return confirm('Delete this task?');">Delete</a>
                        <form method="post" action="{% url 'enrich_task' task.id %}" class="inline">
                          {% csrf_token %}
                          <button class="px-2 py-1 bg-secondary text-secondary-foreground rounded" title="Enrich with AI" type="submit">Enrich</button>
                        </form>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Calendar (FullCalendar) -->
            <div id="calendar-section-{{ project.id }}">
              <h4 class="font-semibold mb-2">Calendar</h4>
              <div id="cal-{{ project.id }}" class="border border-border rounded h-[320px] md:h-[380px] lg:h-[420px]"></div>
            </div>

            <!-- Gantt (jsgantt-improved) -->
            <div id="gantt-section-{{ project.id }}">
              <h4 class="font-semibold mb-2">Gantt <span class="text-xs text-muted-foreground">({{ project.tasks.count }} tasks)</span></h4>
              <div id="gchart-{{ project.id }}" class="border border-border rounded overflow-auto"
                   data-proj-start="{% if project.start_date %}{{ project.start_date|date:"Y-m-d" }}{% endif %}"
                   data-proj-end="{% if project.end_date %}{{ project.end_date|date:"Y-m-d" }}{% endif %}"
                   data-gantt='[
                {% for t in project.tasks.all %}
                  {"id":"{{ t.id }}","name":"{{ t.title|escapejs }}",
                   "start":"{% if t.start_date %}{{ t.start_date|date:"Y-m-d" }}{% endif %}",
                   "end":"{% if t.due_date %}{{ t.due_date|date:"Y-m-d" }}{% endif %}",
                   "status":"{% if t.status == 'IN_PROGRESS' %}IN_PROGRESS{% elif t.status == 'DONE' %}DONE{% else %}TODO{% endif %}",
                   "progress": {{ t.progress|default_if_none:0 }}
                  }{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]'></div>
            </div>

            <!-- Project Media Upload & Gallery -->
            <div id="media-section-{{ project.id }}">
              <h4 class="font-semibold mb-2">Project Media</h4>
              <form method="post" enctype="multipart/form-data" action="{% url 'projects' %}?project={{ project.id }}" class="flex flex-col gap-2 md:flex-row md:items-end">
                {% csrf_token %}
                <input type="hidden" name="action" value="upload_media" />
                <input type="hidden" name="project" value="{{ project.id }}" />
                <div class="flex-1">
                  <label class="block text-sm mb-1">Upload file</label>
                  <input type="file" name="file" class="block w-full text-sm" accept="image/*,video/*,.gif" />
                </div>
                <div class="flex-1">
                  <label class="block text-sm mb-1">Or paste URL</label>
                  <input type="url" name="url" placeholder="https://..." class="w-full p-2 border border-input rounded" />
                </div>
                <div class="flex-1">
                  <label class="block text-sm mb-1">Caption</label>
                  <input name="caption" class="w-full p-2 border border-input rounded" />
                </div>
                <button class="px-3 py-2 bg-primary text-primary-foreground rounded" type="submit">Add Media</button>
              </form>
              <div id="media-{{ project.id }}" class="mt-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" data-media='[
                {% for m in project.media.all %}
                  {"src":"{{ m.file.url|default:m.url|escapejs }}","type":"{{ m.media_type }}","caption":"{{ m.caption|default:''|escapejs }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]'>
                {% for m in project.media.all %}
                  <div class="border border-border rounded p-2 cursor-pointer" data-index="{{ forloop.counter0 }}" onclick="openLightbox('{{ project.id }}', this.dataset.index)">
                    {% if m.media_type == 'image' %}
                      <div class="w-full aspect-[4/3] overflow-hidden rounded">
                        <img src="{{ m.file.url|default:m.url }}" alt="{{ m.caption }}" class="w-full h-full object-cover" />
                      </div>
                    {% elif m.media_type == 'video' %}
                      <div class="w-full aspect-[4/3] overflow-hidden rounded">
                        <video class="w-full h-full object-cover" muted>
                          <source src="{{ m.file.url|default:m.url }}" />
                        </video>
                      </div>
                    {% else %}
                      <div class="text-sm"><a href="{{ m.file.url|default:m.url }}" class="text-blue-600 hover:underline" target="_blank" rel="noopener">Open</a></div>
                    {% endif %}
                    {% if m.caption %}<div class="mt-1 text-xs">{{ m.caption }}</div>{% endif %}
                  </div>
                {% empty %}
                  <div class="text-sm text-muted-foreground col-span-full">No media yet.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="text-sm text-muted-foreground">No projects found.</div>
      {% endfor %}
    </div>

    <nav class="mt-6 flex justify-center">
        <ul class="inline-flex items-center space-x-1">
            {% if page_obj.has_previous %}
            <li>
                <a class="px-3 py-1 border border-border rounded hover:bg-primary hover:text-primary-foreground" href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&status={{ status_selected }}">Previous</a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <li>
                <a class="px-3 py-1 border border-border rounded {% if num == page_obj.number %}bg-primary text-primary-foreground{% else %}hover:bg-secondary hover:text-secondary-foreground{% endif %}" href="?page={{ num }}&search={{ search_query }}&status={{ status_selected }}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li>
                <a class="px-3 py-1 border border-border rounded hover:bg-primary hover:text-primary-foreground" href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&status={{ status_selected }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
  </div>

  <div>
    <div class="bg-card text-card-foreground rounded p-4 border border-border">
      <h2 class="text-xl font-medium mb-2">Overview</h2>
      <ul class="text-sm space-y-1">
        <li>Planned: {{ project_status_counts.PLANNED }}</li>
        <li>In Progress: {{ project_status_counts.IN_PROGRESS }}</li>
        <li>Completed: {{ project_status_counts.COMPLETED }}</li>
        <li>On Hold: {{ project_status_counts.ON_HOLD }}</li>
        <li>Total Budget: ${{ total_budget }}</li>
      </ul>
    </div>
  </div>
</div>

<!-- Lightbox modal -->
<div id="lightbox" class="fixed inset-0 bg-black/80 hidden z-50">
  <div class="w-full h-full flex items-center justify-center relative p-4">
    <button class="absolute top-4 right-4 px-3 py-1 bg-white/20 text-white rounded" onclick="closeLightbox()">Close</button>
    <button class="absolute left-4 top-1/2 -translate-y-1/2 px-3 py-2 bg-white/20 text-white rounded" onclick="prevMedia()">‹</button>
    <div id="lightbox-content" class="text-center"></div>
    <button class="absolute right-4 top-1/2 -translate-y-1/2 px-3 py-2 bg-white/20 text-white rounded" onclick="nextMedia()">›</button>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsgantt-improved/dist/jsgantt.css" />
<script src="https://cdn.jsdelivr.net/npm/jsgantt-improved/dist/jsgantt.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
  function renderFrappeGantt(container, tasks, projStart, projEnd){
    try{
      if(typeof Gantt === 'undefined'){ container.innerHTML = '<div class="p-3 text-sm text-red-600">Gantt assets blocked. Check your network/CSP.</div>'; return false; }
      // Map tasks into Frappe format, with safe date fallbacks
      const pad = n => (n<10? '0'+n : ''+n);
      const toYMD = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const addDays = (ymd, days)=>{
        const [Y,M,D] = (ymd||'').split('-').map(x=>parseInt(x,10));
        let dt = (Y && M && D) ? new Date(Y, M-1, D) : new Date();
        dt.setDate(dt.getDate() + (days||0));
        return toYMD(dt);
      };
      const today = toYMD(new Date());
      const data = tasks.map((t,i)=>{
        let s = (t.start||'').trim() || (t.end||'').trim() || (projStart||'').trim() || today;
        let e = (t.end||'').trim() || (t.start||'').trim() || (projEnd||'').trim() || s;
        if(e === s){ e = addDays(s, 1); }
        const cls = (t.status === 'DONE') ? 'bar-green' : ((t.status === 'IN_PROGRESS') ? 'bar-blue' : 'bar-yellow');
        return { id: t.id || (i+1), name: t.name || ('Task '+(i+1)), start: s, end: e, progress: t.progress || 0, custom_class: cls };
      });
      container.innerHTML = ''; // clear
      new Gantt(container, data, {
        view_mode: 'Week',
        date_format: 'YYYY-MM-DD',
        custom_popup_html: (task) => `<div class="p-2"><div class="font-medium">${task.name}</div><div class="text-xs">${task._start.format('YYYY-MM-DD')} → ${task._end.format('YYYY-MM-DD')}</div><div class="text-xs">${task.progress||0}%</div></div>`
      });
      return true;
    }catch(e){
      console.error('Frappe Gantt error', e);
      container.innerHTML = '<div class="p-3 text-sm text-red-600">Unable to render Gantt.</div>';
      return false;
    }
  }

  function renderJSGantt(container){
    const raw = container.getAttribute('data-gantt') || '[]';
    console.log('Gantt raw:', raw);
    let tasks = [];
    try { tasks = JSON.parse(raw); } catch(e) { console.error('Gantt JSON parse error:', e); tasks = []; }
    const projStart = container.getAttribute('data-proj-start') || '';
    const projEnd = container.getAttribute('data-proj-end') || '';
    console.log('Gantt tasks parsed:', tasks.length, tasks);
    if(!tasks.length){ container.innerHTML = '<div class="p-3 text-sm text-muted-foreground">No tasks yet.</div>'; return false; }
    if(typeof JSGantt === 'undefined' || !JSGantt || !JSGantt.GanttChart){
      console.warn('JSGantt not available, falling back to Frappe Gantt');
      return renderFrappeGantt(container, tasks, projStart, projEnd);
    }
    try{
      const g = new JSGantt.GanttChart(container, 'week');
      if(typeof g.setDateInputFormat === 'function'){ g.setDateInputFormat('yyyy-mm-dd'); }
      g.setOptions({ vFormat: 'week', vChartScale: 'week', vShowRes: 0, vShowComp: 1, vShowDur: 0, vShowStartDate: 1, vShowEndDate: 1, vUseSingleCell: 10000, vToday: new Date() });
      const pad = n => (n<10? '0'+n : ''+n);
      const toYMD = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const addDays = (ymd, days)=>{ const [Y,M,D] = (ymd||'').split('-').map(x=>parseInt(x,10)); let dt = (Y && M && D) ? new Date(Y, M-1, D) : new Date(); dt.setDate(dt.getDate() + (days||0)); return toYMD(dt); };
      const today = toYMD(new Date());
      tasks.forEach((t, i) => {
        const cls = t.status === 'DONE' ? 'gtaskgreen' : (t.status === 'IN_PROGRESS' ? 'gtaskblue' : 'gtaskyellow');
        let s = (t.start||'').trim() || (t.end||'').trim() || (projStart||'').trim() || today;
        let e = (t.end||'').trim() || (t.start||'').trim() || (projEnd||'').trim() || s;
        if(e === s){ e = addDays(s, 1); }
        g.AddTaskItemObject({ pID: t.id || (i+1), pName: t.name || ('Task '+(i+1)), pStart: s, pEnd: e, pClass: cls, pComp: t.progress || 0, pGroup: 0, pParent: 0, pOpen: 1 });
      });
      g.Draw();
      g.DrawDependencies();
      return true;
    }catch(e){
      console.warn('JSGantt failed, falling back to Frappe Gantt', e);
      return renderFrappeGantt(container, tasks, projStart, projEnd);
    }
  }

  function toggleProject(id){
    const wrap = document.getElementById('project-'+id);
    if(!wrap) return;
    wrap.classList.toggle('hidden');
    const calEl = document.getElementById('cal-'+id);
    if(calEl && !calEl.dataset.inited){
      let events = [];
      try { events = JSON.parse(wrap.getAttribute('data-events')||'[]'); } catch (e) { events = []; }
      const cal = new FullCalendar.Calendar(calEl, { initialView: 'dayGridMonth', height: '100%', contentHeight: 'auto', aspectRatio: 1.4, eventDisplay: 'block', dayMaxEventRows: 3, events });
      cal.render();
      calEl.dataset.inited = '1';
    }

    const gEl = document.getElementById('gchart-'+id);
    if(gEl && !gEl.dataset.inited){
      const drawn = renderJSGantt(gEl);
      if(drawn){ gEl.dataset.inited = '1'; }
    }

    // progress bars inside cards
    wrap.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
      const p = parseInt(el.getAttribute('data-progress'), 10);
      if(!isNaN(p)) el.style.width = Math.max(0, Math.min(100, p)) + '%';
    });
  }

  // Auto-open project panel if ?project=ID is present
  document.addEventListener('DOMContentLoaded', function(){
    const params = new URLSearchParams(window.location.search);
    const pid = params.get('project');
    if(pid){
      toggleProject(pid);
      const btn = document.querySelector(`button[onclick="toggleProject('${pid}')"]`);
      if(btn){ btn.scrollIntoView({behavior:'smooth', block:'start'}); }
    }
  });

  // Simple lightbox for media
  let currentMediaList = [];
  let currentMediaIndex = 0;
  function openLightbox(projectId, index){
    const grid = document.getElementById('media-'+projectId);
    try { currentMediaList = JSON.parse(grid.getAttribute('data-media') || '[]'); } catch(e) { currentMediaList = []; }
    currentMediaIndex = parseInt(index || 0, 10) || 0;
    renderLightbox();
    document.getElementById('lightbox').classList.remove('hidden');
  }
  function renderLightbox(){
    const item = currentMediaList[currentMediaIndex];
    const box = document.getElementById('lightbox-content');
    if(!item){ closeLightbox(); return; }
    let html = '';
    if(item.type === 'image'){
      html = `<img src="${item.src}" class="max-h-[80vh] max-w-[90vw] object-contain" alt="">`;
    } else if(item.type === 'video'){
      html = `<video class="max-h-[80vh] max-w-[90vw]" controls autoplay><source src="${item.src}"></video>`;
    } else {
      html = `<a href="${item.src}" target="_blank" class="text-white underline">Open file</a>`;
    }
    if(item.caption){ html += `<div class="mt-2 text-white text-sm">${item.caption}</div>`; }
    box.innerHTML = html;
  }
  function closeLightbox(){ document.getElementById('lightbox').classList.add('hidden'); }
  function nextMedia(){ if(!currentMediaList.length) return; currentMediaIndex = (currentMediaIndex + 1) % currentMediaList.length; renderLightbox(); }
  function prevMedia(){ if(!currentMediaList.length) return; currentMediaIndex = (currentMediaIndex - 1 + currentMediaList.length) % currentMediaList.length; renderLightbox(); }
  document.addEventListener('keydown', function(e){
    const lb = document.getElementById('lightbox');
    if(lb.classList.contains('hidden')) return;
    if(e.key === 'Escape') closeLightbox();
    if(e.key === 'ArrowRight') nextMedia();
    if(e.key === 'ArrowLeft') prevMedia();
  });

  function copyAIInstructions(btn){
    try{
      const container = btn.closest('details');
      const list = container ? container.querySelector('ol') : null;
      if(!list) return;
      const text = Array.from(list.querySelectorAll('li')).map(li=>`- ${li.textContent.trim()}`).join('\n');
      navigator.clipboard.writeText(text);
    }catch(e){ /* noop */ }
  }
  // Ensure progress bars render in new row layout too
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
      const p = parseInt(el.getAttribute('data-progress'), 10);
      if(!isNaN(p)) el.style.width = Math.max(0, Math.min(100, p)) + '%';
    });
  });
</script>
{% endblock %}

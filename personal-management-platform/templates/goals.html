{% extends 'base.html' %}
{% load ai_extras %}
{% block content %}
<h1 class="text-2xl font-semibold mb-6">Savings Goals</h1>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div class="lg:col-span-2">
    <h2 class="text-lg font-medium mb-2">Goals (Drag to reorder priority)</h2>
  <ul id="goal-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      {% for g in goals %}
      <li class="border border-border rounded p-3 bg-card text-card-foreground flex items-start justify-between gap-3" data-id="{{ g.id }}">
        <div class="flex-1">
          <div class="font-medium">{{ g.title }}</div>
          {% if g.description %}<div class="text-sm text-muted-foreground">{{ g.description }}</div>{% endif %}
          <div class="mt-2 text-xs">Progress: ${{ g.current_amount }} / ${{ g.target_amount }}</div>
          <div class="mt-1 h-2 bg-muted rounded overflow-hidden"><div class="h-2 bg-primary" data-pct="{{ g.current_amount|percent:g.target_amount }}"></div></div>
          <div class="mt-2 text-xs text-muted-foreground">Remaining: ${{ g.remaining_amount }} • Weeks alone at ${{ weekly }}/wk: {{ g.weeks_to_complete_alone|default:'—' }}</div>
          <details class="mt-3">
            <summary class="text-xs underline cursor-pointer">Edit</summary>
            <form method="post" class="mt-2 grid gap-2 md:grid-cols-2">
              {% csrf_token %}
              <input type="hidden" name="action" value="edit_goal" />
              <input type="hidden" name="id" value="{{ g.id }}" />
              <input name="title" value="{{ g.title }}" class="p-2 border rounded" placeholder="Title" />
              <input name="description" value="{{ g.description }}" class="p-2 border rounded" placeholder="Description" />
              <input name="target_amount" type="number" step="0.01" min="0" value="{{ g.target_amount }}" class="p-2 border rounded" placeholder="Target" />
              <input name="current_amount" type="number" step="0.01" min="0" value="{{ g.current_amount }}" class="p-2 border rounded" placeholder="Current" />
              <div class="md:col-span-2"><button class="px-2 py-1 border rounded">Save</button></div>
            </form>
          </details>
        </div>
        <div class="flex flex-col gap-2 text-xs">
          <form method="post" onsubmit="return confirm('Delete this goal?')">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_goal" />
            <input type="hidden" name="id" value="{{ g.id }}" />
            <button class="px-2 py-1 border rounded text-destructive">Delete</button>
          </form>
        </div>
      </li>
      {% empty %}
      <li class="text-sm text-muted-foreground">No goals yet.</li>
      {% endfor %}
    </ul>
  </div>
  <div>
    <h2 class="text-lg font-medium mb-2">Schedule</h2>
    <div class="border border-border rounded p-3 text-sm">
      {% if weekly <= 0 %}
      <div class="text-muted-foreground">Set a weekly amount to see time estimates.</div>
      {% else %}
        <ol class="list-decimal ml-5 space-y-1">
        {% for s in schedule %}
          <li>
            <div class="font-medium">{{ s.title }}</div>
            <div class="text-muted-foreground">Remaining: ${{ s.remaining }} • Weeks: {{ s.weeks }} • ETA: {% if s.eta_date %}{{ s.eta_date }}{% else %}—{% endif %}</div>
          </li>
        {% endfor %}
        </ol>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bottom controls: Weekly Pool and Add Goal -->
<div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
  <div class="border border-border rounded p-4 bg-muted/10">
    <h2 class="text-lg font-medium mb-2">Weekly Savings Pool</h2>
    <form method="post" class="flex gap-2 items-end">
      {% csrf_token %}
      <input type="hidden" name="action" value="set_weekly" />
      {{ plan_form.weekly_amount }}
      <button class="px-3 py-2 bg-primary text-primary-foreground rounded" type="submit">Save</button>
      <span class="text-xs text-muted-foreground">Money available each week for your goals</span>
    </form>
  </div>
  <div class="border border-border rounded p-4">
    <h2 class="text-lg font-medium mb-2">Add Goal</h2>
    <form method="post" class="grid gap-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_goal" />
      {{ goal_form.title }}
      {{ goal_form.description }}
      <div class="grid grid-cols-2 gap-2">
        {{ goal_form.target_amount }}
        {{ goal_form.current_amount }}
      </div>
      <div>
        <button class="px-3 py-2 bg-primary text-primary-foreground rounded" type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Minimal drag-and-drop reorder
  const list = document.getElementById('goal-list');
  if(list){
    let dragEl = null;
    list.querySelectorAll('li').forEach(li => {
      li.draggable = true;
      li.addEventListener('dragstart', () => { dragEl = li; li.classList.add('opacity-50'); });
      li.addEventListener('dragend', () => { li.classList.remove('opacity-50'); dragEl = null; });
      li.addEventListener('dragover', (e) => {
        e.preventDefault();
        const rect = li.getBoundingClientRect();
        const before = (e.clientY - rect.top) < rect.height / 2;
        list.insertBefore(dragEl, before ? li : li.nextSibling);
      });
    });
    list.addEventListener('drop', async () => {
      const ids = Array.from(list.querySelectorAll('li')).map(li => parseInt(li.dataset.id));
      try{
        const res = await fetch('{% url "goals_reorder" %}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if(res.ok){ window.location.reload(); }
      }catch(e){}
    });
  }

  // Set progress bar widths
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('[data-pct]').forEach(el => {
      const pct = parseInt(el.getAttribute('data-pct') || '0', 10);
      el.style.width = Math.max(0, Math.min(100, pct)) + '%';
    });
  });
</script>
{% endblock %}

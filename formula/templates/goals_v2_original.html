{% load static %}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <title>Financial Goals Dashboard (Original Static)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script type="module" src="https://unpkg.com/lucide-react@0.378.0/dist/esm/lucide-react.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@radix-ui/colors@latest/black-alpha.css" />
  <script>
    /* Minimal Tailwind-esque utility subset for layout (static approximation) */
  </script>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; margin:0; }
    .app-bg { background:#f8fafc; min-height:100vh; padding:1.5rem; }
    @media (min-width:640px){ .app-bg{padding:2rem;} }
  .container { width:100%; max-width:1600px; margin:0 auto; }
    h1 { font-size:1.875rem; line-height:2.25rem; margin:0; font-weight:700; }
    .muted { color:#64748b; }
  .cards { display:flex; flex-direction:column; gap:1.5rem; }
  @media (min-width:1024px){ .cards{ flex-direction:row; align-items:stretch; flex-wrap:nowrap; } .cards>div{ flex:1; } }
  .card { background:#fff; border:1px solid #e2e8f0; border-radius:0.75rem; display:flex; flex-direction:column; box-shadow:0 1px 2px rgba(0,0,0,0.05); position:relative; cursor:grab; }
  .card.dragging { opacity:.4; }
    .card-head { padding:1rem 1.25rem 0.5rem; display:flex; justify-content:space-between; gap:.75rem; }
    .title { display:flex; align-items:center; gap:.5rem; font-size:1rem; font-weight:600; margin:0; }
    .desc { font-size:.75rem; color:#64748b; margin:.25rem 0 0; }
    .progress-wrap { text-align:center; padding:1rem 1rem .5rem; }
    .big { font-size:2rem; font-weight:700; margin:.25rem 0; }
    .bar { height:12px; width:100%; background:#e2e8f0; border-radius:6px; overflow:hidden; }
    .bar>div { height:100%; background:#0f172a; }
    .range { display:flex; justify-content:space-between; font-size:10px; text-transform:uppercase; color:#64748b; margin-top:4px; }
    .footer { background:#f1f5f9; padding:0.75rem 1rem 1rem; font-size:.75rem; display:flex; flex-direction:column; gap:.5rem; border-top:1px solid #e2e8f0; }
    .row { display:flex; justify-content:space-between; }
    .status-badge { font-size:10px; padding:3px 8px; border-radius:999px; background:#e2e8f0; color:#0f172a; font-weight:600; display:inline-flex; align-items:center; gap:4px; }
  .arrow { display:flex; align-items:center; justify-content:center; padding:0 .25rem; }
  .arrow svg { width:32px; height:32px; stroke:#cbd5e1; transition:transform .2s; }
  /* Rotate arrow when stacked vertically (mobile) */
  @media (max-width:1023px){ .cards .arrow svg { transform:rotate(90deg); } }
  @media (min-width:1024px){ .arrow{ min-width:40px; } }
  @media (min-width:1024px){ .arrow{ min-width:40px; } }
  /* Modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.45); display:flex; align-items:center; justify-content:center; z-index:50; }
  .modal { background:#fff; width:100%; max-width:500px; border-radius:1rem; padding:1.25rem 1.5rem 1.5rem; border:1px solid #e2e8f0; box-shadow:0 15px 50px -5px rgba(0,0,0,0.25); }
  .modal h2 { margin:0 0 .75rem; font-size:.85rem; letter-spacing:.05em; text-transform:uppercase; font-weight:600; color:#334155; }
  .modal form { display:grid; gap:.6rem; }
  .modal .row2 { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
  .btn { background:#0f172a; color:#fff; border:none; border-radius:8px; padding:.55rem .85rem; font-size:.7rem; letter-spacing:.05em; font-weight:600; cursor:pointer; }
  .btn.outline { background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
  .btn.danger { background:#b91c1c; }
  .modal input, .modal textarea, .modal select { padding:.55rem .65rem; font-size:.75rem; border:1px solid #cbd5e1; border-radius:8px; font-family:inherit; background:#fff; }
  .drop-indicator { position:absolute; inset:0; border:2px dashed #6366f1; border-radius:0.75rem; pointer-events:none; }
    button.add { background:#0f172a; color:#fff; border:none; border-radius:0.5rem; padding:.625rem 1rem; font-size:.875rem; cursor:pointer; display:inline-flex; align-items:center; gap:.5rem; }
  </style>
</head>
<body>
  {{ goals|json_script:"goals-data" }}
  <div id="root"></div>
  <script>
    const e = React.createElement;
    const jsonEl = document.getElementById('goals-data');
    let initialGoals = [];
    if(jsonEl){
      try { initialGoals = JSON.parse(jsonEl.textContent); } catch(e) { console.warn('Goal JSON parse error', e); }
    }
    function sequence(goals){
      let cursor = new Date();
      return goals.map(g=>{
        const startDate = new Date(cursor);
        const remaining = g.targetAmount - g.currentAmount;
        const months = (remaining>0 && g.monthlyContribution>0)? remaining / g.monthlyContribution : 0;
        const completionDate = new Date(startDate);
        if(months>0){ completionDate.setMonth(completionDate.getMonth()+months); }
        cursor = completionDate;
        return { ...g, startDate, completionDate };
      });
    }
    function GoalCard({goal,onEdit,onDelete,onDragStart,onDragOver,onDrop,draggingId}){
      const progress = goal.targetAmount>0 ? (goal.currentAmount/goal.targetAmount)*100 : 100;
      const rem = goal.targetAmount - goal.currentAmount;
      const today = new Date();
      const completed = progress>=100;
      const active = !completed && goal.startDate <= today;
      const status = completed? 'Completed': active? 'Active':'Pending';
      const pct = Math.round(progress);
      const isDragging = draggingId===goal.id;
      return e('div',{
        className:'card'+(isDragging?' dragging':''),
        draggable:true,
        onDragStart:(ev)=>onDragStart(ev,goal),
        onDragOver:(ev)=>onDragOver(ev,goal),
        onDrop:(ev)=>onDrop(ev,goal)
      },[
        e('div',{className:'card-head'},[
          e('div',{},[
            e('h3',{className:'title'},[goal.type==='debt'?'🚗':goal.type==='savings'?'🏦':'🎯',goal.name]),
            goal.description && e('p',{className:'desc'},goal.description)
          ]),
          e('div',{style:{display:'flex',gap:'.5rem'}},[
            e('button',{onClick:()=>onEdit(goal),style:{background:'#e2e8f0',border:'1px solid #cbd5e1',fontSize:12,padding:'4px 8px',borderRadius:6,cursor:'pointer'}},'Edit'),
            e('button',{onClick:()=>{ if(confirm('Delete goal?')) onDelete(goal);},style:{background:'#fee2e2',border:'1px solid #fecaca',fontSize:12,padding:'4px 8px',borderRadius:6,cursor:'pointer'}},'Del')
          ])
        ]),
        e('div',{className:'progress-wrap'},[
          e('div',{className:'big'},'$'+goal.currentAmount.toLocaleString()),
          e('div',{className:'bar'}, e('div',{style:{width:pct+'%'}})),
          e('div',{className:'range'},['0%', pct+'%', '100%']),
          e('div',{className:'muted', style:{fontSize:'12px'}},'Target: $'+goal.targetAmount.toLocaleString())
        ]),
        e('div',{className:'footer'},[
          e('div',{},[
            e('span',{className:'status-badge'},status),
            e('div',{className:'muted',style:{marginTop:4}}, status==='Pending'? 'Est. Start: '+goal.startDate.toLocaleDateString(undefined,{month:'short',year:'numeric'}) : status==='Active'? 'Est. End: '+goal.completionDate.toLocaleDateString(undefined,{month:'short',year:'numeric'}) : 'Finished: '+goal.completionDate.toLocaleDateString(undefined,{month:'short',year:'numeric'}))
          ]),
          e('div',{},[
            e('div',{className:'row'},[e('span',{className:'muted'},'Remaining'), e('span',{},'$'+rem.toLocaleString())]),
            e('div',{className:'row'},[e('span',{className:'muted'},'Monthly'), e('span',{},'$'+goal.monthlyContribution.toLocaleString())])
          ])
        ])
      ]);
    }
    function App(){
      const [goals,setGoals] = React.useState(sequence(initialGoals));
      const [form,setForm] = React.useState({name:'',description:'',targetAmount:'',currentAmount:'',monthlyContribution:'',type:'savings'});
  const [editing,setEditing] = React.useState(null);
      const [draggingId,setDraggingId] = React.useState(null);
  const [showAdd,setShowAdd] = React.useState(false);
  const [saving,setSaving] = React.useState(false);
      async function api(path, opts={}){ try { const r= await fetch(path,{headers:{'Content-Type':'application/json'},...opts}); const txt= await r.text(); let data={}; try{ data= txt? JSON.parse(txt):{}; }catch(parseErr){ data={ok:r.ok,error:'Parse error',raw:txt}; } if(typeof data.ok==='undefined') data.ok=r.ok; data._status=r.status; return data;} catch(err){ return {ok:false,error:'Network error',detail:err.message}; } }
      function refresh(){ api('/personal/goals/v2/api/list').then(d=>{ if(d.ok){ setGoals(sequence(d.goals)); } }); }
  function handleAdd(e){ e.preventDefault(); if(saving) return; setSaving(true); const payload={...form,targetAmount:parseFloat(form.targetAmount||'0'),currentAmount:parseFloat(form.currentAmount||'0'),monthlyContribution:parseFloat(form.monthlyContribution||'0')}; api('/personal/goals/v2/api/add',{method:'POST',body:JSON.stringify(payload)}).then(()=>{ setForm({name:'',description:'',targetAmount:'',currentAmount:'',monthlyContribution:'',type:'savings'}); setSaving(false); setShowAdd(false); refresh(); }).catch(()=>setSaving(false)); }
      function openEdit(goal){ setEditing({...goal}); }
      function saveEdit(e){
        e.preventDefault();
        if(saving || !editing) return;
        const safeNum=v=>{ const n=parseFloat(v); return Number.isFinite(n)? n:0; };
        const payload={
          name: (editing.name||'').trim()||'Untitled',
          description: editing.description||'',
          targetAmount: safeNum(editing.targetAmount),
          currentAmount: safeNum(editing.currentAmount),
          monthlyContribution: safeNum(editing.monthlyContribution),
          type: editing.type||'savings'
        };
        setSaving(true);
        api(`/personal/goals/v2/api/update/${editing.id}/`, {method:'POST', body: JSON.stringify(payload)})
          .then(r=>{ if(r.ok){ setEditing(null); refresh(); } else { alert(r.error||'Save failed'); } })
          .catch(err=>{ alert('Network error'); console.error(err); })
          .finally(()=> setSaving(false));
      }
      function handleDelete(goal){ api(`/personal/goals/v2/api/delete/${goal.id}/`, {method:'POST'}).then(()=> refresh()); }
      const seq = sequence(goals);
      function onDragStart(ev,goal){ setDraggingId(goal.id); ev.dataTransfer.effectAllowed='move'; }
      function onDragOver(ev,goal){ ev.preventDefault(); }
      function onDrop(ev,goal){ ev.preventDefault(); if(!draggingId||draggingId===goal.id) return; const order=[...seq]; const from=order.findIndex(g=>g.id===draggingId); const to=order.findIndex(g=>g.id===goal.id); if(from===-1||to===-1) return; const [m]=order.splice(from,1); order.splice(to,0,m); setGoals(order); setDraggingId(null); api('/personal/goals/reorder/',{method:'POST', body: JSON.stringify({ids: order.map(g=>g.id)})}); }
      return e('div',{className:'app-bg'},
        e('div',{className:'container'},[
          e('header',{style:{marginBottom:'2rem', display:'flex', flexDirection:'column', gap:'1rem'}},[
            e('div',{},[
              e('h1',{},'Financial Goals Dashboard'),
              e('p',{className:'muted', style:{marginTop:4}},'Your sequenced plan to financial success.')
            ]),
            !showAdd && e('div',{style:{display:'flex',alignItems:'center',gap:8}},[
              e('button',{onClick:()=>setShowAdd(true),style:{background:'#0f172a',color:'#fff',border:'none',padding:'0.45rem 0.85rem',borderRadius:8,fontSize:13,cursor:'pointer'}},'+ Add Goal')
            ]),
            showAdd && e('form',{onSubmit:handleAdd, style:{display:'grid', gap:'0.5rem', maxWidth:480, background:'#ffffff', padding:'1rem', border:'1px solid #e2e8f0', borderRadius:12, position:'relative'}},[
              e('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},[
                e('strong',{style:{fontSize:'0.7rem',textTransform:'uppercase',letterSpacing:'0.08em'}},'Add Goal'),
                e('button',{type:'button',onClick:()=>setShowAdd(false),style:{background:'transparent',border:'none',cursor:'pointer',fontSize:16,lineHeight:1,color:'#64748b'}},'×')
              ]),
              e('input',{placeholder:'Title',required:true,value:form.name,onChange:e=>setForm(f=>({...f,name:e.target.value})),style:inputStyle()}),
              e('textarea',{placeholder:'Description',value:form.description,onChange:e=>setForm(f=>({...f,description:e.target.value})),rows:2,style:inputStyle()}),
              e('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}},[
                e('input',{type:'number',step:'0.01',placeholder:'Target',value:form.targetAmount,onChange:e=>setForm(f=>({...f,targetAmount:e.target.value})),style:inputStyle()}),
                e('input',{type:'number',step:'0.01',placeholder:'Current',value:form.currentAmount,onChange:e=>setForm(f=>({...f,currentAmount:e.target.value})),style:inputStyle()}),
              ]),
              e('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}},[
                e('input',{type:'number',step:'0.01',placeholder:'Monthly',value:form.monthlyContribution,onChange:e=>setForm(f=>({...f,monthlyContribution:e.target.value})),style:inputStyle()}),
                e('select',{value:form.type,onChange:e=>setForm(f=>({...f,type:e.target.value})),style:inputStyle()},[
                  e('option',{value:'savings'},'Savings'),
                  e('option',{value:'debt'},'Debt'),
                ])
              ]),
              e('button',{type:'submit',disabled:saving,style:{background:saving?'#334155':'#0f172a',opacity:saving?.7:1,color:'#fff',border:'none',padding:'0.5rem 0.75rem',borderRadius:8,fontSize:13,cursor:'pointer'}}, saving?'Saving...':'Add Goal')
            ])
          ]),
          e('main',{},[
            e('div',{className:'cards'}, seq.map((g,i)=>
              e('div',{key:g.id},[
                e(GoalCard,{goal:g,onEdit:openEdit,onDelete:handleDelete,onDragStart,onDragOver,onDrop,draggingId}),
                (i<seq.length-1)? e('div',{className:'arrow'}, e('svg',{fill:'none',stroke:'currentColor',viewBox:'0 0 24 24'}, e('path',{d:'M9 5l7 7-7 7',strokeWidth:1.5,strokeLinecap:'round',strokeLinejoin:'round'}))):null
              ])
            ))
          ]),
          editing && e('div',{className:'modal-backdrop',onClick:(e)=>{ if(e.target.classList.contains('modal-backdrop')&&!saving) setEditing(null); }},[
            e('div',{className:'modal'},[
              e('h2',{},'Edit Goal'),
              e('form',{onSubmit:saveEdit},[
                e('input',{value:editing.name,onChange:ev=>setEditing(g=>({...g,name:ev.target.value})),placeholder:'Title',required:true}),
                e('textarea',{value:editing.description||'',onChange:ev=>setEditing(g=>({...g,description:ev.target.value})),rows:3,placeholder:'Description'}),
                e('div',{className:'row2'},[
                  e('input',{type:'number',step:'0.01',value:editing.targetAmount,onChange:ev=>setEditing(g=>({...g,targetAmount:ev.target.value})) ,placeholder:'Target'}),
                  e('input',{type:'number',step:'0.01',value:editing.currentAmount,onChange:ev=>setEditing(g=>({...g,currentAmount:ev.target.value})) ,placeholder:'Current'}),
                ]),
                e('div',{className:'row2'},[
                  e('input',{type:'number',step:'0.01',value:editing.monthlyContribution,onChange:ev=>setEditing(g=>({...g,monthlyContribution:ev.target.value})) ,placeholder:'Monthly'}),
                  e('select',{value:editing.type,onChange:ev=>setEditing(g=>({...g,type:ev.target.value}))},[
                    e('option',{value:'savings'},'Savings'),
                    e('option',{value:'debt'},'Debt'),
                  ])
                ]),
                e('div',{style:{display:'flex',gap:'.5rem',marginTop:'.25rem'}},[
                  e('button',{type:'submit',disabled:saving,className:'btn',style:saving?{opacity:.7}:{}}
                  , saving?'Saving...':'Save'),
                  e('button',{type:'button',disabled:saving,className:'btn outline',onClick:()=>setEditing(null)},'Cancel')
                ])
              ])
            ])
          ])
        ])
      );
    }
    function inputStyle(){return {padding:'0.5rem 0.65rem',fontSize:13,border:'1px solid #cbd5e1',borderRadius:8,background:'#fff',resize:'vertical'} }
    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>